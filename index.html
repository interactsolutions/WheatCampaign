<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriVista - Buttril Super Field Activations</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }
        
        :root {
            --primary: #2e7d32;
            --primary-dark: #1b5e20;
            --secondary: #ff9800;
            --light: #f5f5f5;
            --dark: #333;
            --gray: #666;
            --light-gray: #e0e0e0;
            --border-radius: 10px;
            --box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        body {
            background-color: #f8f9fa;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Header Styles */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 25px 30px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 300px;
            background: rgba(255,255,255,0.1);
            border-radius: 50%;
            transform: translate(30%, -30%);
        }
        
        .header h1 {
            font-size: 2.2rem;
            margin-bottom: 5px;
            position: relative;
            z-index: 1;
        }
        
        .build-date {
            font-size: 0.9rem;
            opacity: 0.9;
            position: relative;
            z-index: 1;
        }
        
        /* Error Banner */
        .error-banner {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: var(--border-radius);
            padding: 15px 20px;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: var(--box-shadow);
        }
        
        .error-banner i {
            font-size: 1.5rem;
        }
        
        .error-banner h3 {
            margin-bottom: 5px;
        }
        
        /* Dashboard Controls */
        .dashboard-controls {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
        }
        
        .control-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
        }
        
        .control-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-dark);
        }
        
        .dropdown, .date-input, .search-input {
            padding: 12px 15px;
            border: 2px solid var(--light-gray);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .dropdown:focus, .date-input:focus, .search-input:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        .date-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
            transform: translateY(-2px);
        }
        
        /* Selection Summary */
        .selection-summary {
            background: white;
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
            border-left: 5px solid var(--primary);
        }
        
        .summary-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            margin-top: 15px;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: var(--gray);
        }
        
        /* Campaign Overview */
        .campaign-section {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
        }
        
        .campaign-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light-gray);
        }
        
        .campaign-title {
            font-size: 1.5rem;
            color: var(--primary-dark);
        }
        
        .overview-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .overview-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: var(--border-radius);
            padding: 25px;
            text-align: center;
            border-top: 4px solid var(--primary);
        }
        
        .overview-card h3 {
            font-size: 2.2rem;
            color: var(--primary);
            margin-bottom: 8px;
        }
        
        .overview-card p {
            color: var(--gray);
            font-weight: 600;
        }
        
        /* Map Container */
        .map-container {
            height: 400px;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
            border: 1px solid var(--light-gray);
        }
        
        #campaignMap {
            width: 100%;
            height: 100%;
        }
        
        .map-banner {
            background: linear-gradient(135deg, var(--primary), var(--primary-dark));
            color: white;
            padding: 15px 20px;
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        /* Navigation Tabs */
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
            margin-bottom: 25px;
            box-shadow: var(--box-shadow);
        }
        
        .tab {
            flex: 1;
            padding: 18px;
            text-align: center;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: var(--gray);
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab.active {
            background-color: var(--primary);
            color: white;
        }
        
        .tab:hover:not(.active) {
            background-color: #f5f5f5;
        }
        
        /* Key Takeaways */
        .key-takeaways {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: var(--box-shadow);
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .metric-card {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            padding: 20px;
            border-left: 4px solid var(--secondary);
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--dark);
        }
        
        /* Media Gallery */
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .gallery-item {
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--box-shadow);
            transition: transform 0.3s;
        }
        
        .gallery-item:hover {
            transform: translateY(-5px);
        }
        
        .gallery-item img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            display: block;
        }
        
        /* City Progress Bars */
        .city-progress {
            margin-top: 20px;
        }
        
        .city-item {
            margin-bottom: 15px;
        }
        
        .city-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        
        .progress-bar {
            height: 10px;
            background-color: var(--light-gray);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            border-radius: 5px;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .control-grid {
                grid-template-columns: 1fr;
            }
            
            .date-group {
                flex-direction: column;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .nav-tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                min-width: 50%;
            }
        }
        
        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--gray);
        }
        
        .loading i {
            font-size: 2rem;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        /* Status Indicator */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            margin-left: 15px;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        /* Map placeholder when Leaflet fails */
        .map-placeholder {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: #f8f9fa;
            color: #666;
            padding: 20px;
            text-align: center;
        }
        
        .map-placeholder i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #2e7d32;
        }
        
        /* Quick checks */
        .quick-checks {
            margin-top: 10px;
            font-size: 0.9rem;
        }
        
        .quick-checks ol {
            margin-left: 20px;
            margin-top: 5px;
        }
        
        .quick-checks li {
            margin-bottom: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <h1><i class="fas fa-seedling"></i> AgriVista</h1>
            <p class="build-date">Build 2025-12-22</p>
            <h2>Buttril Super Field Activations</h2>
        </header>

        <!-- Error Banner -->
        <div id="errorBanner" class="error-banner" style="display: none;">
            <i class="fas fa-exclamation-triangle"></i>
            <div>
                <h3>Dashboard failed to load</h3>
                <p id="errorMessage"></p>
                <div class="quick-checks">
                    <p><strong>Quick checks:</strong></p>
                    <ol>
                        <li>All assets are properly hosted</li>
                        <li>Check browser DevTools → Console for errors</li>
                        <li>JavaScript is enabled in your browser</li>
                    </ol>
                </div>
            </div>
        </div>

        <!-- Dashboard Controls -->
        <section class="dashboard-controls">
            <div class="control-grid">
                <div class="control-group">
                    <label for="cityFilter"><i class="fas fa-city"></i> City</label>
                    <select id="cityFilter" class="dropdown">
                        <option value="all">All Cities</option>
                        <option value="sukkur">Sukkur (SKR)</option>
                        <option value="dgk">Dera Ghazi Khan (DGK)</option>
                        <option value="faisalabad">Faisalabad (FSD)</option>
                        <option value="gujranwala">Gujranwala (GSM)</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label for="spotFilter"><i class="fas fa-map-marker-alt"></i> Spot</label>
                    <select id="spotFilter" class="dropdown">
                        <option value="all">All Spots</option>
                        <option value="spot1">Major Spots</option>
                        <option value="spot2">Secondary Spots</option>
                        <option value="spot3">Rural Areas</option>
                    </select>
                </div>
                
                <div class="control-group">
                    <label><i class="fas fa-calendar-alt"></i> Date Range</label>
                    <div class="date-group">
                        <input type="date" id="dateFrom" class="date-input" value="2025-11-24">
                        <span>to</span>
                        <input type="date" id="dateTo" class="date-input" value="2025-12-12">
                    </div>
                </div>
                
                <div class="control-group">
                    <label for="searchInput"><i class="fas fa-search"></i> Search</label>
                    <input type="text" id="searchInput" class="search-input" placeholder="Search city, spot, reason...">
                </div>
            </div>
            
            <div class="button-group">
                <button id="searchBtn" class="btn btn-primary">
                    <i class="fas fa-search"></i> Search
                </button>
                <button id="exportBtn" class="btn btn-secondary">
                    <i class="fas fa-file-export"></i> Export CSV
                </button>
                <button id="resetBtn" class="btn btn-secondary">
                    <i class="fas fa-redo"></i> Reset
                </button>
            </div>
        </section>

        <!-- Selection Summary -->
        <section class="selection-summary">
            <h3><i class="fas fa-filter"></i> Selection Summary</h3>
            <div class="summary-stats">
                <div class="stat-item">
                    <span class="stat-value" id="sessionCount">40</span>
                    <span class="stat-label">Sessions</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="farmerCount">2,908</span>
                    <span class="stat-label">Farmers</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="acreCount">44,256</span>
                    <span class="stat-label">Acres</span>
                </div>
                <div class="status-indicator status-success" id="statusIndicator">
                    <i class="fas fa-check-circle"></i>
                    <span id="statusText">Dashboard Loaded</span>
                </div>
            </div>
        </section>

        <!-- Campaign Overview -->
        <section class="campaign-section">
            <div class="campaign-header">
                <h2 class="campaign-title">
                    <i class="fas fa-tractor"></i> Buttril Super Farmer Education Drive
                </h2>
                <div class="campaign-duration">
                    17-day campaign • 24 Nov - 12 Dec 2025
                </div>
            </div>
            
            <div class="overview-stats">
                <div class="overview-card">
                    <h3 id="totalSessions">40</h3>
                    <p>TOTAL SESSIONS</p>
                </div>
                <div class="overview-card">
                    <h3 id="totalFarmers">2,908</h3>
                    <p>FARMERS REACHED</p>
                </div>
                <div class="overview-card">
                    <h3 id="totalAcres">44,256</h3>
                    <p>WHEAT ACRES</p>
                </div>
            </div>
            
            <!-- Map Container -->
            <div class="map-container">
                <div class="map-banner" id="mapBanner">
                    <span><i class="fas fa-map-marked-alt"></i> Campaign Coverage Map</span>
                    <span id="mapStats">40 Sessions • 4 Cities • 2,908 Farmers</span>
                </div>
                <div id="campaignMap">
                    <!-- Map placeholder - will be replaced by Leaflet -->
                    <div class="map-placeholder">
                        <i class="fas fa-map-marked-alt"></i>
                        <h3>Campaign Coverage Map</h3>
                        <p>Map loading... If this persists, check your internet connection.</p>
                        <div style="margin-top: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                            <div style="background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <strong>Sukkur (SKR)</strong><br>15 sessions
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <strong>Dera Ghazi Khan (DGK)</strong><br>10 sessions
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <strong>Faisalabad (FSD)</strong><br>8 sessions
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                <strong>Gujranwala (GSM)</strong><br>7 sessions
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Navigation Tabs -->
        <div class="nav-tabs">
            <button class="tab active" data-tab="snapshot">
                <i class="fas fa-camera"></i> Snapshot
            </button>
            <button class="tab" data-tab="analytics">
                <i class="fas fa-chart-bar"></i> Analytics
            </button>
            <button class="tab" data-tab="map">
                <i class="fas fa-map"></i> Map & Route
            </button>
            <button class="tab" data-tab="gallery">
                <i class="fas fa-images"></i> Gallery
            </button>
            <button class="tab" data-tab="sessions">
                <i class="fas fa-calendar-day"></i> Sessions
            </button>
        </div>

        <!-- Tab Content -->
        <div id="tabContent">
            <!-- Snapshot Tab (Default) -->
            <section class="key-takeaways" id="snapshotTab">
                <h2><i class="fas fa-bullseye"></i> Key Takeaways</h2>
                <p><strong>Scope:</strong> All sessions</p>
                <p>Sessions: 40 · Farmers: 2,908 · Acres: 44,256</p>
                
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value">90%</div>
                        <p>Definite Intent</p>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">84%</div>
                        <p>Awareness</p>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value">60%</div>
                        <p>Clarity</p>
                    </div>
                </div>
                
                <!-- City Progress -->
                <div class="city-progress">
                    <h3><i class="fas fa-chart-line"></i> City-wise Performance</h3>
                    <div class="city-item">
                        <div class="city-header">
                            <span>Sukkur (SKR)</span>
                            <span>15 sessions</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 85%"></div>
                        </div>
                    </div>
                    <div class="city-item">
                        <div class="city-header">
                            <span>Dera Ghazi Khan (DGK)</span>
                            <span>10 sessions</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 70%"></div>
                        </div>
                    </div>
                    <div class="city-item">
                        <div class="city-header">
                            <span>Faisalabad (FSD)</span>
                            <span>8 sessions</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 65%"></div>
                        </div>
                    </div>
                    <div class="city-item">
                        <div class="city-header">
                            <span>Gujranwala (GSM)</span>
                            <span>7 sessions</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 60%"></div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Gallery Tab (Hidden by default) -->
            <section class="campaign-section" id="galleryTab" style="display: none;">
                <h2><i class="fas fa-images"></i> Campaign Gallery</h2>
                <p>Photos from field activations and farmer education sessions</p>
                
                <div class="gallery-grid" id="mediaGallery">
                    <!-- Images will be loaded here dynamically -->
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading media gallery...</p>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- ALL JAVASCRIPT EMBEDDED IN THE SAME FILE -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // ============================================
        // AGRI-VISTA DASHBOARD - ALL JAVASCRIPT IN ONE FILE
        // ============================================
        
        console.log('AgriVista Dashboard Loading...');
        
        // Initialize variables
        let map = null;
        let campaignData = null;
        
        // Campaign data (embedded in JavaScript)
        const campaignDataEmbedded = {
            campaign: "Buttril Super Farmer Education Drive",
            period: "2025-11-24 to 2025-12-12",
            duration: "17 days",
            totalSessions: 40,
            totalFarmers: 2908,
            totalAcres: 44256,
            cities: [
                { code: "SKR", name: "Sukkur", sessions: 15, farmers: 1120, acres: 16800 },
                { code: "DGK", name: "Dera Ghazi Khan", sessions: 10, farmers: 728, acres: 10920 },
                { code: "FSD", name: "Faisalabad", sessions: 8, farmers: 640, acres: 9600 },
                { code: "GSM", name: "Gujranwala", sessions: 7, farmers: 420, acres: 6936 }
            ],
            metrics: {
                definiteIntent: 90,
                awareness: 84,
                clarity: 60
            }
        };
        
        // City coordinates
        const cityCoordinates = {
            'sukkur': { lat: 27.7132, lng: 68.8482, name: 'Sukkur (SKR)' },
            'dgk': { lat: 30.0489, lng: 70.6402, name: 'Dera Ghazi Khan (DGK)' },
            'faisalabad': { lat: 31.4504, lng: 73.1350, name: 'Faisalabad (FSD)' },
            'gujranwala': { lat: 32.1877, lng: 74.1945, name: 'Gujranwala (GSM)' }
        };
        
        // Media data
        const mediaData = [
            {
                id: 1,
                filename: "assets/Bayer.png",
                caption: "Bayer Logo",
                type: "logo"
            },
            {
                id: 2,
                filename: "assets/Buctril.jpg",
                caption: "Buttril Super Product",
                type: "product"
            },
            {
                id: 3,
                filename: "assets/Interact.gif",
                caption: "Interact Solutions Animation",
                type: "animation"
            },
            {
                id: 4,
                filename: "assets/poductts.jpg",
                caption: "Product Range Display",
                type: "product"
            },
            {
                id: 5,
                filename: "assets/Atlantis.jpg",
                caption: "Atlantis Herbicide Reference",
                type: "reference"
            },
            {
                id: 6,
                filename: "https://images.unsplash.com/photo-1505253668822-42074d58a7c6?w=400&h=300&fit=crop",
                caption: "Farmer Education Session",
                type: "event",
                city: "sukkur"
            },
            {
                id: 7,
                filename: "https://images.unsplash.com/photo-1560493676-04071c5f467b?w=400&h=300&fit=crop",
                caption: "Field Demonstration",
                type: "demonstration",
                city: "dgk"
            },
            {
                id: 8,
                filename: "https://images.unsplash.com/photo-1500382017468-9049fed747ef?w=400&h=300&fit=crop",
                caption: "Product Distribution",
                type: "distribution",
                city: "faisalabad"
            }
        ];
        
        // Main initialization
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing dashboard...');
            
            try {
                // Set campaign data
                campaignData = campaignDataEmbedded;
                
                // Initialize all components
                initDashboard();
                setupEventListeners();
                initMap();
                
                // Update UI
                updateDashboard();
                
                // Hide error banner
                document.getElementById('errorBanner').style.display = 'none';
                
                // Update status
                updateStatus('success', 'Dashboard loaded successfully');
                
                console.log('Dashboard initialized successfully!');
            } catch (error) {
                console.error('Error initializing dashboard:', error);
                showError(`Initialization error: ${error.message}`);
            }
        });
        
        // Initialize dashboard
        function initDashboard() {
            console.log('Initializing dashboard components...');
            
            // Set date limits
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('dateTo').max = today;
            
            // Update stats display
            document.getElementById('sessionCount').textContent = campaignData.totalSessions;
            document.getElementById('farmerCount').textContent = campaignData.totalFarmers.toLocaleString();
            document.getElementById('acreCount').textContent = campaignData.totalAcres.toLocaleString();
            
            document.getElementById('totalSessions').textContent = campaignData.totalSessions;
            document.getElementById('totalFarmers').textContent = campaignData.totalFarmers.toLocaleString();
            document.getElementById('totalAcres').textContent = campaignData.totalAcres.toLocaleString();
        }
        
        // Set up event listeners
        function setupEventListeners() {
            console.log('Setting up event listeners...');
            
            // Search button
            document.getElementById('searchBtn').addEventListener('click', function() {
                applyFilters();
            });
            
            // Export button
            document.getElementById('exportBtn').addEventListener('click', function() {
                exportToCSV();
            });
            
            // Reset button
            document.getElementById('resetBtn').addEventListener('click', function() {
                resetFilters();
            });
            
            // Tab navigation
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    switchTab(tabId);
                });
            });
            
            // Search input enter key
            document.getElementById('searchInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    applyFilters();
                }
            });
            
            console.log('Event listeners set up successfully');
        }
        
        // Initialize map
        function initMap() {
            console.log('Initializing map...');
            
            try {
                // Create map centered on Pakistan
                map = L.map('campaignMap').setView([30.3753, 69.3451], 6);
                
                // Add OpenStreetMap tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 18
                }).addTo(map);
                
                // Add city markers
                addCityMarkers();
                
                // Update map banner
                updateMapBanner();
                
                console.log('Map initialized successfully');
            } catch (error) {
                console.error('Error initializing map:', error);
                // Map will show placeholder content
            }
        }
        
        // Add city markers to map
        function addCityMarkers() {
            if (!map) return;
            
            Object.keys(cityCoordinates).forEach(cityKey => {
                const city = cityCoordinates[cityKey];
                const cityStats = campaignData.cities.find(c => c.code === cityKey.toUpperCase());
                
                if (cityStats) {
                    // Create marker
                    const marker = L.marker([city.lat, city.lng]).addTo(map);
                    
                    // Create popup content
                    const popupContent = `
                        <div style="padding: 10px; min-width: 200px;">
                            <h4 style="margin: 0 0 10px 0; color: #2e7d32;">${city.name}</h4>
                            <p><strong>Sessions:</strong> ${cityStats.sessions}</p>
                            <p><strong>Farmers:</strong> ${cityStats.farmers.toLocaleString()}</p>
                            <p><strong>Acres:</strong> ${cityStats.acres.toLocaleString()}</p>
                            <button onclick="filterCity('${cityKey}')" 
                                    style="background: #2e7d32; color: white; border: none; padding: 8px 16px; 
                                           border-radius: 4px; cursor: pointer; margin-top: 10px; width: 100%;">
                                <i class="fas fa-filter"></i> Filter this city
                            </button>
                        </div>
                    `;
                    
                    marker.bindPopup(popupContent);
                }
            });
        }
        
        // UPDATE MAP BANNER FUNCTION (This was missing!)
        function updateMapBanner() {
            console.log('Updating map banner...');
            
            try {
                const banner = document.getElementById('mapStats');
                if (banner && campaignData) {
                    banner.innerHTML = `
                        <i class="fas fa-calendar-check"></i> ${campaignData.totalSessions} Sessions • 
                        <i class="fas fa-city"></i> ${campaignData.cities.length} Cities • 
                        <i class="fas fa-users"></i> ${campaignData.totalFarmers.toLocaleString()} Farmers
                    `;
                }
                console.log('Map banner updated');
            } catch (error) {
                console.error('Error updating map banner:', error);
            }
        }
        
        // Filter by city (called from map popup)
        function filterCity(cityKey) {
            const cityName = cityCoordinates[cityKey]?.name || cityKey;
            document.getElementById('cityFilter').value = cityKey;
            document.getElementById('searchInput').value = cityName;
            applyFilters();
        }
        
        // Update dashboard
        function updateDashboard() {
            console.log('Updating dashboard...');
            
            if (!campaignData) return;
            
            // Get filtered data
            const filteredData = getFilteredData();
            
            // Update selection summary
            document.getElementById('sessionCount').textContent = filteredData.sessions;
            document.getElementById('farmerCount').textContent = filteredData.farmers.toLocaleString();
            document.getElementById('acreCount').textContent = filteredData.acres.toLocaleString();
            
            // Update progress bars based on filter
            updateProgressBars(filteredData);
            
            // Update status
            updateStatus('success', `Showing ${filteredData.sessions} of ${campaignData.totalSessions} sessions`);
        }
        
        // Get filtered data based on current filters
        function getFilteredData() {
            const cityFilter = document.getElementById('cityFilter').value;
            
            if (cityFilter === 'all') {
                return {
                    sessions: campaignData.totalSessions,
                    farmers: campaignData.totalFarmers,
                    acres: campaignData.totalAcres
                };
            } else {
                const city = campaignData.cities.find(c => c.code === cityFilter.toUpperCase());
                if (city) {
                    return {
                        sessions: city.sessions,
                        farmers: city.farmers,
                        acres: city.acres
                    };
                }
            }
            
            return {
                sessions: 0,
                farmers: 0,
                acres: 0
            };
        }
        
        // Update progress bars
        function updateProgressBars(filteredData) {
            const cityFilter = document.getElementById('cityFilter').value;
            
            if (cityFilter === 'all') {
                // Show all cities with full progress
                document.querySelectorAll('.progress-fill').forEach((fill, index) => {
                    const percentages = [85, 70, 65, 60];
                    if (index < percentages.length) {
                        fill.style.width = `${percentages[index]}%`;
                    }
                });
            } else {
                // Highlight only selected city
                document.querySelectorAll('.progress-fill').forEach((fill, index) => {
                    const cities = ['sukkur', 'dgk', 'faisalabad', 'gujranwala'];
                    if (cities[index] === cityFilter) {
                        fill.style.width = '100%';
                    } else {
                        fill.style.width = '20%';
                    }
                });
            }
        }
        
        // Apply filters
        function applyFilters() {
            console.log('Applying filters...');
            
            const cityFilter = document.getElementById('cityFilter').value;
            const dateFrom = document.getElementById('dateFrom').value;
            const dateTo = document.getElementById('dateTo').value;
            const searchQuery = document.getElementById('searchInput').value;
            
            // Update dashboard
            updateDashboard();
            
            // Update status
            updateStatus('success', 'Filters applied successfully');
            
            console.log(`Filters: City=${cityFilter}, Dates=${dateFrom} to ${dateTo}, Search="${searchQuery}"`);
        }
        
        // Reset filters
        function resetFilters() {
            console.log('Resetting filters...');
            
            document.getElementById('cityFilter').value = 'all';
            document.getElementById('spotFilter').value = 'all';
            document.getElementById('dateFrom').value = '2025-11-24';
            document.getElementById('dateTo').value = '2025-12-12';
            document.getElementById('searchInput').value = '';
            
            updateDashboard();
            updateStatus('success', 'All filters reset');
            
            console.log('Filters reset to default');
        }
        
        // Switch tabs
        function switchTab(tabId) {
            console.log(`Switching to tab: ${tabId}`);
            
            // Update active tab
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('data-tab') === tabId) {
                    tab.classList.add('active');
                }
            });
            
            // Show selected tab, hide others
            const tabContents = ['snapshotTab', 'galleryTab'];
            tabContents.forEach(contentId => {
                const element = document.getElementById(contentId);
                if (element) {
                    element.style.display = contentId === tabId + 'Tab' ? 'block' : 'none';
                }
            });
            
            // Load content for specific tabs
            if (tabId === 'gallery') {
                loadGallery();
            } else if (tabId === 'map' && map) {
                // Trigger map resize
                setTimeout(() => {
                    if (map) map.invalidateSize();
                }, 100);
            }
            
            updateStatus('success', `Switched to ${tabId} view`);
        }
        
        // Load gallery
        function loadGallery() {
            console.log('Loading gallery...');
            
            const galleryContainer = document.getElementById('mediaGallery');
            if (!galleryContainer) return;
            
            // Filter media by current city filter
            const cityFilter = document.getElementById('cityFilter').value;
            let filteredMedia = mediaData;
            
            if (cityFilter !== 'all') {
                filteredMedia = mediaData.filter(media => 
                    !media.city || media.city === cityFilter
                );
            }
            
            // Create gallery HTML
            let galleryHTML = '';
            
            filteredMedia.forEach(media => {
                galleryHTML += `
                    <div class="gallery-item">
                        <img src="${media.filename}" alt="${media.caption}" 
                             onerror="this.src='https://images.unsplash.com/photo-1505253668822-42074d58a7c6?w=400&h=300&fit=crop'">
                        <div style="padding: 15px; background: white;">
                            <p style="font-weight: 600; margin: 0 0 5px 0;">${media.caption}</p>
                            <small style="color: #666;">${media.type}</small>
                            ${media.city ? `<br><small style="color: #2e7d32;">${media.city}</small>` : ''}
                        </div>
                    </div>
                `;
            });
            
            galleryContainer.innerHTML = galleryHTML || `
                <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: #666;">
                    <i class="fas fa-images"></i>
                    <p>No media found for current filters</p>
                </div>
            `;
            
            console.log(`Gallery loaded with ${filteredMedia.length} items`);
        }
        
        // Export to CSV
        function exportToCSV() {
            console.log('Exporting to CSV...');
            
            // Create CSV content
            let csvContent = "City,Sessions,Farmers,Acres,Intent%,Awareness%,Clarity%\n";
            
            campaignData.cities.forEach(city => {
                csvContent += `${city.name},${city.sessions},${city.farmers},${city.acres},${campaignData.metrics.definiteIntent},${campaignData.metrics.awareness},${campaignData.metrics.clarity}\n`;
            });
            
            // Add totals
            csvContent += `TOTAL,${campaignData.totalSessions},${campaignData.totalFarmers},${campaignData.totalAcres},${campaignData.metrics.definiteIntent},${campaignData.metrics.awareness},${campaignData.metrics.clarity}\n`;
            
            // Create download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            
            link.href = url;
            link.setAttribute('download', `Buttril_Campaign_Export_${new Date().toISOString().slice(0,10)}.csv`);
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            updateStatus('success', 'CSV exported successfully');
            
            console.log('CSV export completed');
        }
        
        // Update status
        function updateStatus(type, message) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            if (!indicator || !statusText) return;
            
            // Update classes
            indicator.className = 'status-indicator';
            if (type === 'success') {
                indicator.classList.add('status-success');
            } else if (type === 'error') {
                indicator.classList.add('status-error');
            }
            
            // Update text
            statusText.textContent = message;
            
            console.log(`Status: ${type} - ${message}`);
        }
        
        // Show error
        function showError(message) {
            console.error('Dashboard Error:', message);
            
            const errorBanner = document.getElementById('errorBanner');
            const errorMessage = document.getElementById('errorMessage');
            
            if (errorBanner && errorMessage) {
                errorMessage.textContent = message;
                errorBanner.style.display = 'flex';
            }
            
            updateStatus('error', 'Error detected');
        }
        
        // Window load handler
        window.onload = function() {
            console.log('AgriVista Dashboard fully loaded and ready!');
            
            // Final status update
            setTimeout(() => {
                updateStatus('success', 'Ready - 40 sessions, 4 cities, 2,908 farmers');
            }, 1000);
        };
        
        // Error handling for missing updateMapBanner
        window.updateMapBanner = updateMapBanner;
        
        console.log('AgriVista Dashboard JavaScript loaded');
    </script>
</body>
</html>
