<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <title>INTERACT | Field Intelligence Dashboard</title>
  <link rel="stylesheet" href="./style.css" />
  <link rel="preconnect" href="https://unpkg.com" crossorigin>
  <link rel="dns-prefetch" href="https://unpkg.com">
  <!-- Leaflet (map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="brand-mark">INTERACT</div>
      <div class="brand-sub">Field Intelligence Dashboard</div>
    </div>
    <div class="top-actions">
      <a class="link" href="./healthcheck.html" title="Troubleshoot loading issues">Healthcheck</a>
      <button id="exportBtn" class="btn btn-primary" type="button">Export CSV</button>
    </div>
  </header>

  <main class="container">
    <div id="errorBanner" class="error-banner hidden" role="alert">
      <div class="error-title">Dashboard failed to load.</div>
      <div id="errorMsg" class="error-msg"></div>
      <div id="errorDetails" class="error-details"></div>
    </div>

    <section class="panel">
      <div class="panel-head">
        <h1 id="campaignTitle">Loading campaign…</h1>
        <div class="panel-sub" id="campaignMeta">—</div>
      </div>

      <div class="controls">
        <div class="control">
          <label for="campaignSelect">Campaign</label>
          <select id="campaignSelect"></select>
        </div>
        <div class="control">
          <label for="districtSelect">District</label>
          <select id="districtSelect">
            <option value="__all__">All</option>
          </select>
        </div>
        <div class="control">
          <label for="searchInput">Search</label>
          <input id="searchInput" type="search" placeholder="Location / Host / Dealer / Facilitator / Session ID" />
        </div>
        <div class="control">
          <label>Date range</label>
          <div class="date-range">
            <input id="fromDate" type="date" />
            <span>to</span>
            <input id="toDate" type="date" />
          </div>
        </div>
        <div class="control control-actions">
          <label>&nbsp;</label>
          <div class="btn-row">
            <button id="applyBtn" class="btn btn-secondary" type="button">Apply</button>
            <button id="resetBtn" class="btn btn-ghost" type="button">Reset</button>
          </div>
        </div>
      </div>

      <div class="kpis">
        <div class="kpi"><div class="kpi-label">Sessions</div><div id="kpiSessions" class="kpi-value">—</div><div class="kpi-sub">Totals recomputed from session rows</div></div>
        <div class="kpi"><div class="kpi-label">Farmers</div><div id="kpiFarmers" class="kpi-value">—</div><div class="kpi-sub">Wheat farmers: <span id="kpiWheatFarmers">—</span></div></div>
        <div class="kpi"><div class="kpi-label">Acres</div><div id="kpiAcres" class="kpi-value">—</div><div class="kpi-sub">Est. Buctril acres: <span id="kpiBuctrilAcres">—</span></div></div>
        <div class="kpi"><div class="kpi-label">Key Influencers</div><div id="kpiInfluencers" class="kpi-value">—</div><div class="kpi-sub">Highlighted names</div></div>
      </div>

      <div class="score-note">
        <div class="score-title">Session Score (0–100)</div>
        <div class="score-desc">35% Definite + 25% Awareness + 15% Used-Last-Year + 25% Understanding (0–3 normalized). Missing values are weight-renormalized.</div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-head">
        <h2>Coverage Map</h2>
        <div class="panel-sub">Markers: <span id="markerCount">—</span>. Marker color is driven by Session Score: High ≥ 85, Medium 70–84.9, Low &lt; 70.</div>
      </div>
      <div id="mapWrap" class="map-wrap">
        <div id="map" class="map"></div>
        <div id="mapFallback" class="map-fallback hidden">
          Map library did not load. You can still browse sessions below.
        </div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-head">
        <h2>Media Gallery</h2>
        <div class="panel-sub"><span id="mediaCount">—</span></div>
      </div>

      <div class="filters">
        <button class="chip active" data-media-filter="__all__" type="button">All</button>
        <button class="chip" data-media-filter="photo" type="button">Photos</button>
        <button class="chip" data-media-filter="video" type="button">Videos</button>
        <button class="chip" data-media-filter="brand" type="button">Brand</button>
      </div>

      <div id="gallery" class="gallery">
        <div class="muted">Loading media…</div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-head">
        <h2>Sessions</h2>
        <div class="panel-sub"><span id="sessionCount">—</span></div>
      </div>

      <div class="table-wrap">
        <table class="table" id="sessionsTable">
          <thead>
            <tr>
              <th>SN</th><th>Date</th><th>District</th><th>Location</th>
              <th class="num">Farmers</th><th class="num">Acres</th>
              <th class="num">Definite %</th><th class="num">Awareness %</th><th class="num">Score</th>
            </tr>
          </thead>
          <tbody id="sessionsTbody">
            <tr><td colspan="9" class="muted">Loading sessions…</td></tr>
          </tbody>
        </table>
      </div>

      <div id="sessionCards" class="cards hidden"></div>
    </section>

    <section class="panel">
      <div class="panel-head">
        <h2>Auto-Insights</h2>
        <div class="panel-sub">Computed from current selection.</div>
      </div>
      <div id="insights" class="insights">
        <div class="muted">Computing insights…</div>
      </div>
    </section>

    <footer class="footer">
      Built by <strong>INTERACT</strong> — multi-campaign field intelligence. Data and KPIs are recomputed from session rows (summary row ignored).
    </footer>
  </main>

  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script defer src="./dashboard.js"></script>
</body>
</html>
