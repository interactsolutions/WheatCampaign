<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>WheatCampaign Healthcheck</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; padding:16px; background:#0b1220; color:#e9f0ff}
    a{color:#8ab4ff}
    .card{border:1px solid #1a2947; border-radius:14px; padding:12px; margin:12px 0; background:rgba(7,11,20,.35)}
    table{width:100%; border-collapse:collapse}
    th,td{padding:10px; border-bottom:1px solid rgba(26,41,71,.55); text-align:left}
    .ok{color:#22c55e; font-weight:800}
    .bad{color:#ef4444; font-weight:800}
    code{background:rgba(255,255,255,.08); padding:2px 6px; border-radius:8px}
  </style>
</head>
<body>
  <h1>Healthcheck</h1>
  <div class="card">
    This page checks whether required files are reachable and valid JSON on GitHub Pages.
    If something is <span class="bad">FAIL</span>, that is why the dashboard stays on “Loading”.
  </div>
  <div class="card">
    <div>Campaign param: <code id="camp">—</code></div>
  </div>
  <div class="card">
    <table>
      <thead><tr><th>Resource</th><th>Status</th><th>Details</th></tr></thead>
      <tbody id="rows"></tbody>
    </table>
  </div>

<script>
(async ()=>{
  const BASE = new URL('./', window.location.href);
  const url = (rel)=> new URL(rel, BASE).toString();
  const camp = new URLSearchParams(location.search).get('campaign') || '(default)';
  document.getElementById('camp').textContent = camp;

  const items = [
    {name:'index.html', u: url('index.html'), json:false},
    {name:'dashboard.js', u: url('dashboard.js'), json:false},
    {name:'style.css', u: url('style.css'), json:false},
    {name:'data/campaigns.json', u: url('data/campaigns.json'), json:true},
  ];

  const tbody = document.getElementById('rows');

  async function check(item){
    try{
      const res = await fetch(item.u, {cache:'no-store'});
      if(!res.ok) throw new Error(res.status+' '+res.statusText);
      if(item.json){
        const j = await res.json();
        return {ok:true, detail: 'valid JSON'};
      }
      return {ok:true, detail: res.headers.get('content-type') || 'ok'};
    }catch(e){
      return {ok:false, detail: String(e.message||e)};
    }
  }

  for(const item of items){
    const r = await check(item);
    const tr = document.createElement('tr');
    tr.innerHTML = '<td><a href="'+item.u+'" target="_blank" rel="noopener">'+item.name+'</a></td>'
      + '<td class="'+(r.ok?'ok':'bad')+'">'+(r.ok?'OK':'FAIL')+'</td>'
      + '<td>'+r.detail+'</td>';
    tbody.appendChild(tr);
  }

  // campaign-specific checks
  try{
    const reg = await (await fetch(url('data/campaigns.json'), {cache:'no-store'})).json();
    const c = reg.campaigns?.find(x=>x.id===camp) || reg.campaigns?.[0];
    if(c){
      const s = await check({name:'sessions', u:url(c.sessionsUrl), json:true});
      const m = await check({name:'media', u:url(c.mediaUrl), json:true});
      const add = (label, res, href) => {
        const tr = document.createElement('tr');
        tr.innerHTML = '<td><a href="'+href+'" target="_blank" rel="noopener">'+label+'</a></td>'
          + '<td class="'+(res.ok?'ok':'bad')+'">'+(res.ok?'OK':'FAIL')+'</td>'
          + '<td>'+res.detail+'</td>';
        tbody.appendChild(tr);
      };
      add('campaign sessions.json', s, url(c.sessionsUrl));
      add('campaign media.json', m, url(c.mediaUrl));
    }
  }catch(e){
    const tr = document.createElement('tr');
    tr.innerHTML = '<td>campaign files</td><td class="bad">FAIL</td><td>'+String(e.message||e)+'</td>';
    tbody.appendChild(tr);
  }
})();
</script>
</body>
</html>
