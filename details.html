<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Session details</title>
  <link rel="icon" href="favicon.ico" />
  <link rel="stylesheet" href="style.css?v=20260101" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div>
        <div class="brandTitle">Session details</div>
        <div class="brandSub"><a id="backLink" class="link" href="index.html">Back</a></div>
      </div>
    </div>
    <div class="controls">
      <div class="control">
        <label>Session</label>
        <div id="hdr" class="muted">—</div>
      </div>
    </div>
  </header>

  <main class="grid2">
    <section class="card">
      <h2>Overview</h2>
      <div id="overview" class="muted">Loading…</div>
      <div class="divider"></div>
      <div class="drawerActions">
        <a class="btn" id="openSheet" href="#">Open sheet</a>
        <a class="btn btnGhost" id="openMaps" href="#" target="_blank" rel="noopener">Open in Google Maps</a>
      </div>

      <div class="divider"></div>
      <h3>Sheet summary</h3>
      <div id="sheetSummary" class="muted">Loading…</div>
    </section>

    <section class="card">
      <h2>Media</h2>
      <div id="media" class="mediaGrid"></div>
    </section>
  </main>

<script>
(() => {
  'use strict';
  const $$ = (s,r=document)=>r.querySelector(s);
  const esc = (s)=>{const d=document.createElement('div'); d.textContent=String(s??''); return d.innerHTML;};
  const BASE = new URL('.', location.href);
  const url = (p)=>new URL(p, BASE).toString();
  const qs = new URLSearchParams(location.search);
  const campaign = qs.get('campaign') || 'buctril-super-2025';
  const sessionId = Number(qs.get('session') || 0);

  $$('#backLink').href = `index.html?campaign=${encodeURIComponent(campaign)}#sessions`;

  async function fetchJson(p) {
    const r = await fetch(url(p), {cache:'no-store'});
    if (!r.ok) throw new Error(`Failed ${p} (${r.status})`);
    return await r.json();
  }

  function normalizeMediaPath(p) {
    const raw = String(p ?? '').trim();
    if (!raw) return '';
    if (/^(https?:|data:|blob:)/i.test(raw)) return raw;
    let x = raw.replace(/^\.?\//,'').replace(/^\//,'');
    if (x.startsWith('assets/')) return x;
    if (x.startsWith('gallery/')) return 'assets/' + x;
    if (!x.includes('/')) return 'assets/gallery/' + x;
    return x;
  }

  function setImg(img, p) {
    const ph = 'assets/placeholder.svg';
    img.src = url(normalizeMediaPath(p) || ph);
    img.onerror = ()=>{img.onerror=null; img.src=url(ph);};
  }

  function setVideo(v, p) {
    const ph = 'assets/placeholder-video.mp4';
    v.src = url(normalizeMediaPath(p) || ph);
    v.onerror = ()=>{v.onerror=null; v.src=url(ph);};
  }

  async function boot() {
    const sj = await fetchJson(`data/${campaign}/sessions.json`);
    const sessions = Array.isArray(sj.sessions) ? sj.sessions : [];
    const s = sessions.find(x => Number(x.id) === sessionId);
    if (!s) throw new Error('Session not found.');

    $$('#hdr').innerHTML = `<b>Session ${esc(s.id)}</b> • <span class="badge">${esc(s.sheetRef||'')}</span> • ${esc(s.date||'')}`;
    $$('#overview').innerHTML = `
      <div><b>District:</b> ${esc(s.district||'')}</div>
      <div><b>Village/Spot:</b> ${esc(s.village||s.spot||'')}</div>
      <div><b>Dealer:</b> ${esc(s.dealer?.nearest||s.dealer?.name||'')}</div>
      <div><b>Host:</b> ${esc(s.host?.name||'')} • ${esc(s.host?.phone||'')}</div>
      <div><b>Sales:</b> ${esc(s.salesRep?.name||'')} • ${esc(s.salesRep?.phone||'')}</div>
      <div><b>Score:</b> ${esc(String(s.score ?? ''))}</div>
    `;

    const sheetUrl = `sheets.html?campaign=${encodeURIComponent(campaign)}&sheet=${encodeURIComponent(s.sheetRef)}`;
    $$('#openSheet').href = sheetUrl;

    const lat = Number(s.geo?.lat), lng = Number(s.geo?.lng);
    const maps = (Number.isFinite(lat)&&Number.isFinite(lng)) ? `https://www.google.com/maps?q=${lat},${lng}` : '#';
    $$('#openMaps').href = maps;

    // Sheet summary
    try {
      const sh = await fetchJson(`data/${campaign}/sheets/${s.sheetRef}.json`);
      const m = sh.meta || {};
      const f = sh.feedback || {};
      const farmers = Array.isArray(sh.farmers) ? sh.farmers : [];
      const top = [...farmers].sort((a,b)=>Number(b.acres||0)-Number(a.acres||0)).slice(0,5);
      $$('#sheetSummary').innerHTML = `
        <div class="muted"><b>${esc(m.sheet||s.sheetRef)}</b> • Date: ${esc(m.date||s.date||'')} • Farmers present: ${esc(String(m.farmers_present||''))} • Acres: ${esc(String(m.acres||''))}</div>
        ${f.host_comment ? `<div><b>Host comment:</b> ${esc(f.host_comment)}</div>` : ''}
        ${f.sales_feedback ? `<div><b>Sales feedback:</b> ${esc(f.sales_feedback)}</div>` : ''}
        ${f.manager_note ? `<div><b>Manager note:</b> ${esc(f.manager_note)}</div>` : ''}
        <div class="divider"></div>
        <div><b>Top farmers</b></div>
        ${top.length ? `<ul>${top.map(x=>`<li>${esc(x.name||'')} — ${esc(String(x.acres ?? ''))} acres</li>`).join('')}</ul>` : '<div class="muted">No farmer rows found.</div>'}
      `;
    } catch (e) {
      $$('#sheetSummary').innerHTML = `<div class="muted">Could not load sheet.</div><div class="smallMuted">${esc(e.message)}</div>`;
    }

    // Media
    const media = $$('#media');
    const imgs = (s.media && Array.isArray(s.media.images)) ? s.media.images : [];
    const vids = (s.media && Array.isArray(s.media.videos)) ? s.media.videos : [];
    const items = [...imgs.map(p=>({type:'image',path:p})), ...vids.map(p=>({type:'video',path:p}))];
    if (!items.length) {
      media.innerHTML = '<div class="muted">No media for this session.</div>';
      return;
    }
    media.innerHTML = items.map((it, i)=> {
      return it.type==='image'
        ? `<div class="mediaThumb"><img data-i="${i}" alt="image"/></div>`
        : `<div class="mediaThumb"><video data-i="${i}" controls playsinline></video></div>`;
    }).join('');
    items.forEach((it, i)=> {
      const el = media.querySelector(`[data-i="${i}"]`);
      if (!el) return;
      if (it.type==='image') setImg(el, it.path);
      else setVideo(el, it.path);
    });
  }

  boot().catch(e=> {
    $$('#overview').innerHTML = `<div class="muted">Failed to load.</div><div class="smallMuted">${esc(e.message)}</div>`;
    $$('#sheetSummary').textContent = '—';
  });
})();
</script>
</body>
</html>
