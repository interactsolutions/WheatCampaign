<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Session details • WheatCampaign</title>
  <link rel="stylesheet" href="./style.css"/>
  <link rel="icon" href="./assets/bayer.svg" type="image/svg+xml"/>
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <img class="brand__logo" src="./assets/bayer.svg" alt="Bayer"/>
      <div class="brand__text">
        <div class="brand__title">Session details</div>
        <div class="brand__subtitle" id="subTitle">—</div>
      </div>
    </div>
    <nav class="tabs">
      <a class="chip" id="backBtn" href="./index.html#sessions">Back</a>
      <a class="chip" id="openSheetBtn" href="./sheets.html">Open sheet</a>
      <a class="chip" id="openDashboardBtn" href="./index.html#summary">Dashboard</a>
    </nav>
  </header>

  <main class="container">
    <section class="card" id="statusCard">
      <div class="muted">Loading session…</div>
    </section>

    <section class="grid2" id="metaGrid" style="display:none"></section>

    <section class="card" id="feedbackCard" style="display:none">
      <div class="card__head"><h2>Supervisor notes & proof</h2></div>
      <div id="feedbackBlock" class="grid2"></div>
    </section>

    <section class="card" id="mediaCard" style="display:none">
      <div class="card__head">
        <h2>Session media</h2>
        <div class="muted" id="mediaHint">Tap an item to open.</div>
      </div>
      <div class="mediaGrid" id="mediaGrid"></div>
    </section>
  </main>

  <dialog id="viewer" class="viewer">
    <button class="viewer__close" id="viewerClose" aria-label="Close">×</button>
    <div class="viewer__body" id="viewerBody"></div>
  </dialog>

<script>
(() => {
  'use strict';
  const $ = (s, r=document) => r.querySelector(s);
  const esc = (s) => String(s ?? '').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));
  const qp = new URLSearchParams(location.search);
  const campaign = qp.get('campaign') || 'buctril-super-2025';
  const sessionKey = qp.get('session') || qp.get('sheet') || qp.get('id');

  function dataUrl(p){ return `./data/${encodeURIComponent(campaign)}/${p}`; }
  function abs(u){ return u.startsWith('http') ? u : ('./' + u.replace(/^\.\//,'')); }

  async function getJson(url){
    const r = await fetch(url, {cache:'no-store'});
    if(!r.ok) throw new Error(url + ' -> ' + r.status);
    return r.json();
  }

  function parseDate(d){
    // Accept YYYY-MM-DD or DD/MM/YYYY
    if(!d) return null;
    if(/^\d{4}-\d{2}-\d{2}$/.test(d)) return new Date(d + 'T00:00:00');
    const m = String(d).match(/^(\d{1,2})\/(\d{1,2})\/(\d{4})$/);
    if(m) return new Date(`${m[3]}-${String(m[2]).padStart(2,'0')}-${String(m[1]).padStart(2,'0')}T00:00:00`);
    const dt = new Date(d);
    return isNaN(dt.getTime()) ? null : dt;
  }

  function fmtDate(d){
    const dt = parseDate(d);
    if(!dt) return '—';
    return dt.toISOString().slice(0,10);
  }

  function cardKV(label, value){
    const div = document.createElement('div');
    div.className = 'kv';
    div.innerHTML = `<div class="kv__k">${esc(label)}</div><div class="kv__v">${esc(value ?? '—')}</div>`;
    return div;
  }

  function openViewer(node){
    const dlg = $('#viewer');
    $('#viewerBody').innerHTML = '';
    $('#viewerBody').appendChild(node);
    dlg.showModal();
  }

  function closeViewer(){ $('#viewer').close(); }
  $('#viewerClose').addEventListener('click', closeViewer);
  $('#viewer').addEventListener('click', (e) => { if(e.target === $('#viewer')) closeViewer(); });

  function mediaThumb(item){
    const wrap = document.createElement('button');
    wrap.type = 'button';
    wrap.className = 'mediaThumb';
    const kind = item.type || (String(item.file||'').toLowerCase().endsWith('.mp4') ? 'video' : 'image');
    const src = abs(item.url || item.file || '');
    const label = item.label || item.title || (kind==='video' ? 'Video' : 'Image');

    wrap.innerHTML = `
      <div class="mediaThumb__frame">
        ${kind==='video' ? `<video muted playsinline preload="metadata" src="${esc(src)}"></video>` : `<img loading="lazy" src="${esc(src)}" alt="${esc(label)}"/>`}
        <div class="mediaThumb__cap">${esc(label)}</div>
      </div>`;
    wrap.addEventListener('click', () => {
      if(kind==='video'){
        const v = document.createElement('video');
        v.src = src; v.controls = true; v.playsInline = true; v.autoplay = true;
        v.style.maxWidth = '100%'; v.style.maxHeight = '80vh';
        openViewer(v);
      } else {
        const img = document.createElement('img');
        img.src = src; img.alt = label;
        img.style.maxWidth='100%'; img.style.maxHeight='80vh';
        openViewer(img);
      }
    });
    return wrap;
  }

  async function main(){
    $('#subTitle').textContent = campaign + (sessionKey ? ` • ${sessionKey}` : '');
    $('#backBtn').href = `./index.html?campaign=${encodeURIComponent(campaign)}#sessions`;
    $('#openDashboardBtn').href = `./index.html?campaign=${encodeURIComponent(campaign)}#summary`;
    $('#openSheetBtn').href = `./sheets.html?campaign=${encodeURIComponent(campaign)}`;

    if(!sessionKey){
      $('#statusCard').innerHTML = '<div class="muted">Missing session id. Open from Sessions table.</div>';
      return;
    }

    let sessions = [];
    let media = [];
    try{
      const [s, m] = await Promise.all([
        getJson(dataUrl('sessions.json')),
        getJson(dataUrl('media.json')).catch(() => ([]))
      ]);
      sessions = Array.isArray(s) ? s : (s.sessions || []);
      media = Array.isArray(m) ? m : (m.items || []);
    }catch(err){
      $('#statusCard').innerHTML = `<div class="muted">Failed to load data: ${esc(err.message)}</div>`;
      return;
    }

    const key = String(sessionKey).toLowerCase();
    const ses = sessions.find(x => String(x.sheetRef||x.id||x.sessionId||x.code||'').toLowerCase()===key)
             || sessions.find(x => String(x.sheet||'').toLowerCase()===key);

    if(!ses){
      $('#statusCard').innerHTML = `<div class="muted">Session not found: <b>${esc(sessionKey)}</b></div>`;
      return;
    }

    const sheetRef = ses.sheetRef || ses.sheet || ses.id || ses.sessionId || ses.code;
    $('#openSheetBtn').href = `./sheets.html?campaign=${encodeURIComponent(campaign)}&sheet=${encodeURIComponent(sheetRef)}#sheet`;

    $('#statusCard').innerHTML = `
      <div class="card__head">
        <h2>Session ${esc(ses.session_no ?? '')}</h2>
        <div class="muted">${esc(fmtDate(ses.date))} • ${esc(ses.district ?? '—')} • ${esc(ses.spot ?? ses.village ?? '—')}</div>
      </div>
      <div class="muted">Farmers: <b>${esc(ses.farmers ?? ses.farmers_present ?? '—')}</b> • Acres: <b>${esc(ses.acres ?? '—')}</b> • Score: <b>${esc((ses.score ?? ses.avg_score ?? '—'))}</b></div>
    `;

    const meta = $('#metaGrid');
    meta.style.display = '';
    meta.innerHTML = '';
    meta.appendChild(cardKV('Host', ses.host || ses.host_name || '—'));
    meta.appendChild(cardKV('Sales rep', ses.sales || ses.sales_name || '—'));
    meta.appendChild(cardKV('Dealer', ses.dealer || '—'));
    meta.appendChild(cardKV('Village / Spot', ses.spot || ses.village || '—'));
    meta.appendChild(cardKV('District', ses.district || '—'));
    meta.appendChild(cardKV('Coordinates', (ses.lat && ses.lon) ? `${ses.lat}, ${ses.lon}` : '—'));
    meta.appendChild(cardKV('Definite %', ses.definite ?? ses.definite_pct ?? '—'));
    meta.appendChild(cardKV('Awareness %', ses.awareness ?? ses.awareness_pct ?? '—'));

    // Try load sheet json for feedback/signatures (optional)
    try{
      const sheet = await getJson(dataUrl(`sheets/${sheetRef}.json`));
      const fb = sheet.feedback || {};
      const sigs = sheet.signatures || {};
      const card = $('#feedbackCard');
      card.style.display = '';
      const block = $('#feedbackBlock');
      block.innerHTML = '';
      const host = document.createElement('div');
      host.className = 'cardLite';
      host.innerHTML = `
        <h4>Host / Supervisor</h4>
        <div class="muted">Name: <b>${esc(fb.host_name || ses.host || '—')}</b></div>
        <div class="muted">Phone: <b>${esc(fb.host_phone || '—')}</b></div>
        <div class="muted">Comment:</div>
        <div class="quote">${esc(fb.host_comment || '—')}</div>
        ${sigs.host ? `<img class="sig" src="${esc(abs(sigs.host))}" alt="Host signature" loading="lazy" onerror="this.style.display='none'"/>` : `<div class="muted">Signature: —</div>`}
      `;
      const sales = document.createElement('div');
      sales.className = 'cardLite';
      sales.innerHTML = `
        <h4>Sales</h4>
        <div class="muted">Name: <b>${esc(fb.sales_name || ses.sales || '—')}</b></div>
        <div class="muted">Phone: <b>${esc(fb.sales_phone || '—')}</b></div>
        <div class="muted">Feedback:</div>
        <div class="quote">${esc(fb.sales_feedback || '—')}</div>
        ${sigs.sales ? `<img class="sig" src="${esc(abs(sigs.sales))}" alt="Sales signature" loading="lazy" onerror="this.style.display='none'"/>` : `<div class="muted">Signature: —</div>`}
      `;
      block.appendChild(host);
      block.appendChild(sales);
    }catch(_e){
      // ok
    }

    // session media
    const mediaFor = media.filter(x => {
      const ref = String(x.sessionRef || x.sheetRef || x.session || x.sheet || x.code || '').toLowerCase();
      return ref === String(sheetRef).toLowerCase();
    });

    if(mediaFor.length){
      $('#mediaCard').style.display = '';
      const grid = $('#mediaGrid');
      grid.innerHTML = '';
      mediaFor.forEach(it => grid.appendChild(mediaThumb(it)));
    }else{
      $('#mediaHint').textContent = 'No media linked to this session in media.json.';
      $('#mediaCard').style.display = '';
    }
  }

  main();
})();
</script>
</body>
</html>
