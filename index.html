<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Harvest Horizons Dashboard</title>
  <link rel="icon" href="favicon.ico" />
  <link rel="stylesheet" href="style.css?v=20260101" />
  <!-- Leaflet CSS with fallback chain -->
  <link id="leafletCss" rel="stylesheet"
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        onerror="this.onerror=null;this.href='https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css'"/>
</head>
<body>
  <!-- Background video -->
  <div class="bg">
    <video class="bgVideo" src="assets/bg.mp4" autoplay muted loop playsinline></video>
    <div class="bgShade"></div>
  </div>
  <header class="topbar">
    <div class="brand">
      <img src="assets/interact.gif" alt="INTERACT" class="brandLogo" onerror="this.style.display='none'"/>
      <div>
        <div class="brandTitle">Harvest Horizons</div>
        <div class="brandSub">Campaign dashboard</div>
      </div>
      <!-- Theme toggle button; displays sun/moon icon depending on current theme -->
      <button class="iconBtn" id="themeToggle" aria-label="Toggle theme">‚òÄ</button>
    </div>

    <!-- Hero video slider moved inside the header. Placing the hero before the controls
         allows the media content to sit above the date and campaign filters. When
         the page is scrolled the sticky header will keep the controls visible
         while the hero naturally scrolls out of view. -->
    <div class="heroWrap" id="heroWrap">
      <div class="heroPlayer" id="heroPlayer">
        <video id="heroVideo" autoplay muted loop playsinline></video>
        <div class="heroOverlay"></div>
        <div class="heroCaption">
          <div id="heroTitle" class="heroTitle"></div>
          <div id="heroSub" class="heroSub"></div>
        </div>
        <!-- Controls and thumbnail icons overlay the video. The previous/next buttons
             remain in the top right corner, while the thumbnail icons line up along
             the bottom edge. -->
        <div class="heroControls">
          <button class="iconBtn" id="heroPrev" aria-label="Previous">‚óÄ</button>
          <button class="iconBtn" id="heroNext" aria-label="Next">‚ñ∂</button>
        </div>
        <div class="heroThumbs" id="heroThumbs"></div>
      </div>
    </div>

    <div class="controls">
      <div class="control">
        <label for="campaignSelect">Campaign</label>
        <select id="campaignSelect"></select>
      </div>

      <div class="control">
        <label>Date range</label>
        <!-- The entire range (from, to) and all action buttons live inside one flex row. This
             ensures a single-line layout on wider screens while still wrapping cleanly
             on narrow viewports. The Export CSV button was moved into the same row as
             Apply/Reset to avoid dropping to a separate line. -->
        <div class="rangeRow">
          <input id="dateFrom" type="date" />
          <span class="muted">to</span>
          <input id="dateTo" type="date" />
          <button class="btn" id="applyBtn">Apply</button>
          <button class="btn btnGhost" id="resetBtn">Reset</button>
          <button class="btn btnGhost" id="exportBtn">Export CSV</button>
        </div>
        <div id="rangeHint" class="smallMuted"></div>
      </div>
      <!-- Filters for farmer (host) name and city -->
      <div class="control">
        <label for="nameFilter">Farmer name</label>
        <input id="nameFilter" type="text" placeholder="Search by host name" />
      </div>
      <div class="control">
        <label for="cityFilter">City</label>
        <input id="cityFilter" type="text" placeholder="Search by city" />
      </div>

      <!-- Additional filters: allow filtering by district and by score range. These help
           campaign managers quickly narrow down sessions based on geography and
           performance metrics. -->
      <div class="control">
        <label for="districtFilter">District</label>
        <input id="districtFilter" type="text" placeholder="Search by district" />
      </div>
      <div class="control">
        <label>Score range</label>
        <div class="scoreRangeRow">
          <input id="scoreMin" type="number" placeholder="Min score" min="0" max="100" step="0.1" />
          <span class="muted">to</span>
          <input id="scoreMax" type="number" placeholder="Max score" min="0" max="100" step="0.1" />
        </div>
      </div>
    </div>
  </header>

  <nav class="tabBar" role="tablist" aria-label="Dashboard tabs">
    <a class="tabBtn tabBtn--active" data-tab="summary" role="tab" aria-selected="true" href="#summary">Summary</a>
    <a class="tabBtn" data-tab="map" role="tab" aria-selected="false" href="#map">Map</a>
    <a class="tabBtn" data-tab="sessions" role="tab" aria-selected="false" href="#sessions">Sessions</a>
    <a class="tabBtn" data-tab="media" role="tab" aria-selected="false" href="#media">Media</a>
    <a class="tabBtn" data-tab="feedback" role="tab" aria-selected="false" href="#feedback">Feedback</a>
  </nav>

  <main id="app" class="">
    <section class="tabPanel grid2" data-tab="summary" id="summary">
      <section class="card">
        <h2>Executive summary</h2>
        <div class="muted">Reach, conversion, and impact indicators computed from session rows only. Use the date filter to segment performance.</div>
        
        <div class="kpis">
          <!-- Each KPI tile is given a specific class for color-coded icon dots. These
               classes correspond to CSS rules that prepend a colored circle before
               the label text, adding visual variety without external icon assets. -->
          <div class="kpi kpi--sessions"><div class="kpiLabel">Sessions</div><div class="kpiVal" id="kpiSessions">‚Äî</div></div>
          <div class="kpi kpi--farmers"><div class="kpiLabel">Farmers reached</div><div class="kpiVal" id="kpiFarmers">‚Äî</div></div>
          <div class="kpi kpi--acres"><div class="kpiLabel">Acres engaged</div><div class="kpiVal" id="kpiAcres">‚Äî</div></div>
          <div class="kpi kpi--estacres"><div class="kpiLabel">Est. Buctril acres</div><div class="kpiVal" id="kpiEstAcres">‚Äî</div></div>
          <div class="kpi kpi--awareness"><div class="kpiLabel">Awareness (avg)</div><div class="kpiVal" id="kpiAwareness">‚Äî</div></div>
          <div class="kpi kpi--definite"><div class="kpiLabel">Definite intent (avg)</div><div class="kpiVal" id="kpiDefinite">‚Äî</div></div>
          <div class="kpi kpi--used"><div class="kpiLabel">Used last year (avg)</div><div class="kpiVal" id="kpiUsedLastYear">‚Äî</div></div>
          <div class="kpi kpi--score"><div class="kpiLabel">Avg session score</div><div class="kpiVal" id="kpiScore">‚Äî</div></div>
        </div>

        <!-- Last updated timestamp and summary takeaways are inserted here. The date
             reflects the most recent session loaded, reassuring users about data
             freshness. The takeaways card surfaces the top two focus districts
             based on the priority table, giving managers an at‚Äëa‚Äëglance view of
             where to act next. -->
        <div id="lastUpdated" class="smallMuted"></div>
        <div id="summaryTakeaways" class="summaryTakeaways"></div>

        <div class="divider"></div>
        <div class="tableWrap">
          <table class="sessionTable" id="topSessionsTable">
            <thead>
              <tr>
                <th>Date</th><th>Sheet</th><th>District</th><th>Village</th><th>Farmers</th><th>Acres</th><th>Score</th><th>Open</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Attendance donut chart: shows distribution of farmers present per session as a percentage
             of the total farmers reached. The chart is rendered via Chart.js in dashboard.js.
             The canvas element will be hidden if no data is available. -->
        <div class="divider"></div>
        <h3>Sessions by farmers attendance</h3>
        <div class="attendanceWrap">
          <canvas id="attendanceDonut"></canvas>
        </div>
      </section>

      
      <section class="card">
        <h2>Outcome funnel and priorities</h2>
        <div class="muted">Percentages are weighted by farmers present (or session farmers if sheet summaries are unavailable).</div>

        <div id="funnel" class="funnel">
          <div class="muted">Loading‚Ä¶</div>
        </div>

        <div class="divider"></div>
        <h3>Where to focus next</h3>
        <div class="smallMuted">Lowest definite intent first (tie-breaker: lower score). Use this list to plan follow-ups, dealer touchpoints, and demo plots.</div>
        <!-- Provide a simple export button for managers who wish to take this
             prioritization table offline. -->
        <div class="actionsRow" style="margin:8px 0">
          <button class="btn btnGhost btnSmall" id="priorityExportBtn">Export CSV</button>
        </div>
        <div class="tableWrap">
          <table class="sessionTable" id="priorityDistrictsTable">
            <thead>
              <tr>
                <th>District</th><th>Sessions</th><th>Farmers</th><th>Acres</th><th>Awareness</th><th>Definite</th><th>Avg score</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <div class="divider"></div>
        <div class="grid2">
          <div class="card card--flat">
            <h3>Top adoption drivers</h3>
            <!-- Bar chart container for drivers. Bars will be drawn via JS -->
            <div id="driversChart" class="barChart"><div class="muted">Loading‚Ä¶</div></div>
          </div>
          <div class="card card--flat">
            <h3>Top barriers</h3>
            <!-- Bar chart container for barriers -->
            <div id="barriersChart" class="barChart"><div class="muted">Loading‚Ä¶</div></div>
          </div>
        </div>

        <div class="divider"></div>
        <h3>Data readiness</h3>
        <div id="statusBox" class="status">Loading‚Ä¶</div>
        <div class="smallMuted">Verify assets and JSON loading using the <a class="link" href="healthcheck.html">Healthcheck</a>.</div>
      </section>

    </section>

    <section class="tabPanel card mapCard" data-tab="map" id="map">
      <div class="mapHeader">
        <div>
          <h2>Map view</h2>
          <div class="muted">Markers reflect the currently filtered date range.</div>
        </div>
        <div id="mapStatus" class="badge">Loading‚Ä¶</div>
      </div>
      <div id="leafletMap" class="map">Loading map‚Ä¶</div>
      <div class="divider"></div>
      <div id="mapFallback" class="smallMuted hidden">
        Map library could not be loaded. Use the Sessions table and ‚ÄúOpen in Google Maps‚Äù links in details.
      </div>
    </section>

    <section class="tabPanel card" data-tab="sessions" id="sessions">
      <div class="row">
        <h2>Sessions</h2>
        <div class="muted">Click a row to preview; use buttons to open sheet/details.</div>
      </div>
      <div class="tableWrap">
        <table class="sessionTable" id="sessionsTable">
          <thead>
            <tr>
              <th>Date</th><th>Sheet</th><th>District</th><th>Village</th><th>Farmers</th><th>Acres</th><th>Score</th><th>Actions</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="tabPanel card" data-tab="media" id="media">
      <div class="row">
        <h2>Media</h2>
        <div class="muted">Thumbnails are pulled from assets/gallery. Missing files will fall back to placeholders.</div>
      </div>
      <div id="mediaGrid" class="mediaGrid"></div>
    </section>

    <section class="tabPanel card" data-tab="feedback" id="feedback">
      <h2>Feedback</h2>
      <div class="muted">We value your feedback. Send us a message via WhatsApp or email by providing the appropriate contact information below.</div>
      <div class="divider"></div>
      <div class="grid2">
        <!-- Feedback form: collects phone or email and a message, and provides buttons to send via WhatsApp or email. -->
        <div class="card">
          <div class="control">
            <label for="fbPhone">Phone (WhatsApp)</label>
            <input type="tel" id="fbPhone" placeholder="Enter phone number" />
          </div>
          <div class="control">
            <label for="fbEmail">Email</label>
            <input type="email" id="fbEmail" placeholder="Enter email address" />
          </div>
          <div class="control">
            <label for="fbMessage">Message</label>
            <textarea id="fbMessage" rows="6" placeholder="Type your feedback here‚Ä¶"></textarea>
          </div>
          <div class="drawerActions">
            <button class="btn" id="fbSendWhatsApp">Send via WhatsApp</button>
            <button class="btn btnGhost" id="fbSendEmail">Send via Email</button>
          </div>
          <div id="fbFeedbackMsg" class="smallMuted"></div>
        </div>
        <div class="card">
          <h3>Quick links</h3>
          <ul class="muted">
            <li><a href="healthcheck.html" class="link">Healthcheck</a></li>
            <li><a href="sheets.html" class="link">Sheets browser</a></li>
            <li><a href="report.html" class="link">Campaign analysis report</a></li>
          </ul>
        </div>
      </div>
    </section>
  </main>

  <!-- Unified footer: combines the static-host and offline-friendly notes into a single footer. -->
  <footer class="footer" aria-label="Footer">
    <div class="footerBrands">
      <div class="brandPill">
        <img src="assets/interact.gif" alt="INTERACT" onerror="this.style.display='none'"/>
        <span>INTERACT Solutions</span>
      </div>
      <div class="brandPill">
        <img src="assets/bayer.svg" alt="Bayer" onerror="this.style.display='none'"/>
        <span>Bayer Crop Science</span>
      </div>
    </div>
    <div class="smallMuted">This dashboard is designed to be static‚Äëhost friendly and offline‚Äëfriendly. Use the Healthcheck to validate data and asset availability.</div>
  </footer>

  <!-- Session drawer overlay -->
  <div class="drawerOverlay hidden" id="drawerOverlay" aria-hidden="true"></div>
  <aside class="drawer hidden" id="sessionDrawer" aria-hidden="true" aria-label="Session details">
    <div class="drawerTop">
      <div>
        <div class="drawerTitle" id="drawerTitle">Session</div>
        <div class="drawerSub" id="drawerSub">‚Äî</div>
      </div>
      <button class="iconBtn" id="drawerClose" aria-label="Close">‚úï</button>
    </div>

    <div class="drawerBody">
      <div class="kpis kpis--compact">
        <div class="kpi"><div class="kpiLabel">Farmers</div><div class="kpiVal" id="dFarmers">‚Äî</div></div>
        <div class="kpi"><div class="kpiLabel">Acres</div><div class="kpiVal" id="dAcres">‚Äî</div></div>
        <div class="kpi"><div class="kpiLabel">Score</div><div class="kpiVal" id="dScore">‚Äî</div></div>
      </div>

      <div class="divider"></div>
      <div id="dMeta" class="muted"></div>

      <div class="divider"></div>
      <h3>Outcomes</h3>
      <div id="dOutcomes" class="muted">‚Äî</div>

      <div class="divider"></div>
      <h3>Recommended next actions</h3>
      <ul id="dActions" class="bullets"><li class="muted">‚Äî</li></ul>

      <div class="divider"></div>
      <div class="drawerActions">
        <a class="btn" id="dOpenSheet" href="#">Open sheet</a>
        <a class="btn btnGhost" id="dOpenDetails" href="#">Open details</a>
        <a class="btn btnGhost" id="dOpenMaps" href="#" target="_blank" rel="noopener">Open in Google Maps</a>
      </div>

      <div class="divider"></div>
      <h3>Sheet summary</h3>
      <div id="dSheetSummary" class="muted">Loading‚Ä¶</div>

      <div class="divider"></div>
      <h3>Media</h3>
      <div id="dMedia" class="mediaRow"></div>
    </div>
  </aside>

  <!-- Lightbox for media -->
  <div id="lightbox" class="lightbox" role="dialog" aria-modal="true" aria-label="Media viewer">
    <div class="lightboxInner">
      <div class="lightboxTop">
        <div id="lbTitle" class="muted">Media</div>
        <button class="iconBtn" id="lbClose" aria-label="Close">‚úï</button>
      </div>
      <div class="lightboxBody" id="lbBody"></div>
    </div>
  </div>


  <!-- Load Chart.js before the dashboard script to enable the attendance donut chart. -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <!-- Leaflet JS is loaded lazily by dashboard.js when the Map tab is opened. -->

  <script src="dashboard.js?v=20260101"></script>

  <!-- Hero slider initialization -->
  <script>
  (function() {
    // Define the videos to cycle through in the hero slider. Each entry can have
    // a title and caption for display in the overlay.
    const videos = [
      { file: 'assets/atlantis.mp4', title: 'Atlantis', caption: 'Atlantis field application' },
      { file: 'assets/bayer.mp4', title: 'Bayer', caption: 'Bayer promotional clip' },
      { file: 'assets/buctril.mp4', title: 'Buctril', caption: 'Buctril product demo' },
      { file: 'assets/interact.mp4', title: 'Interact', caption: 'Interact Solutions overview' }
    ];
    let current = 0;
    const heroVideo = document.getElementById('heroVideo');
    const heroTitle = document.getElementById('heroTitle');
    const heroSub = document.getElementById('heroSub');
    const thumbContainer = document.getElementById('heroThumbs');
    const prevBtn = document.getElementById('heroPrev');
    const nextBtn = document.getElementById('heroNext');
    // Function to update the hero player to the specified index
    function setHero(i) {
      current = (i + videos.length) % videos.length;
      const v = videos[current];
      if (heroVideo) {
        heroVideo.src = v.file;
        // Restart playback when source changes
        heroVideo.load();
      }
      if (heroTitle) heroTitle.textContent = v.title;
      if (heroSub) heroSub.textContent = v.caption;
      // Update active state on thumbnails
      Array.from(thumbContainer.children).forEach((el, idx) => {
        if (idx === current) el.classList.add('active');
        else el.classList.remove('active');
      });
    }
    // Build thumbnail elements once DOM is ready
    videos.forEach((v, idx) => {
      const d = document.createElement('div');
      d.className = 'heroThumb';
      // Use a small preview video for each thumb; fallback to image if missing
      d.innerHTML = `<video autoplay loop muted playsinline src="${v.file}"></video><div class="badge">${idx+1}</div>`;
      d.addEventListener('click', () => setHero(idx));
      thumbContainer.appendChild(d);
    });
    // Navigation buttons
    prevBtn?.addEventListener('click', () => setHero(current - 1));
    nextBtn?.addEventListener('click', () => setHero(current + 1));
    // Initialize the first video
    setHero(0);
  })();
  </script>

  <!-- Theme toggle initialization -->
  <script>
  (function() {
    // Toggle between light and dark themes based on the time of day or user interaction.
    const htmlEl = document.documentElement;
    const toggleBtn = document.getElementById('themeToggle');
    function applyTheme(t) {
      htmlEl.setAttribute('data-theme', t);
      localStorage.setItem('theme', t);
      if (toggleBtn) toggleBtn.textContent = (t === 'light') ? 'üåô' : '‚òÄ';
    }
    const saved = localStorage.getItem('theme');
    if (saved === 'light' || saved === 'dark') {
      applyTheme(saved);
    } else {
      const hr = new Date().getHours();
      const defaultTheme = (hr >= 6 && hr < 18) ? 'light' : 'dark';
      applyTheme(defaultTheme);
    }
    if (toggleBtn) {
      toggleBtn.addEventListener('click', () => {
        const current = htmlEl.getAttribute('data-theme');
        applyTheme(current === 'light' ? 'dark' : 'light');
      });
    }
  })();
  </script>
</body>
</html>
