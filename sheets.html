<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Raw sheet viewer</title>
  <link rel="icon" href="favicon.ico" />
  <link rel="stylesheet" href="style.css?v=20260101" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div>
        <div class="brandTitle">Raw sheet viewer</div>
        <div class="brandSub">Audit underlying sheet exports. <a id="backLink" class="link" href="index.html">Back to report</a></div>
      </div>
    </div>
    <div class="controls">
      <div class="control">
        <label for="sheetSelect">Sheet</label>
        <select id="sheetSelect"></select>
      </div>
      <div class="control">
        <label>Search</label>
        <input id="sheetSearch" placeholder="D1S1, village, district…" />
      </div>
    </div>
  </header>

  <main class="grid2">
    <section class="card">
      <h2>Sheet details</h2>
      <div id="meta" class="muted">Loading…</div>
      <div class="smallMuted">Use this view for audits and debugging. Business insights and actions are summarized on the main dashboard.</div>
      <div class="divider"></div>

      <div class="grid2">
        <div class="card">
          <h3>Feedback</h3>
          <div id="feedback" class="muted">—</div>
        </div>
        <div class="card">
          <h3>Signatures</h3>
          <div class="mediaRow" id="sigs"></div>
        </div>
      </div>

      <div class="divider"></div>
      <h3>Farmers</h3>
      <div class="tableWrap">
        <table class="sessionTable" id="farmersTable">
          <thead><tr id="farmersHead"></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>All sheets</h2>
      <div id="sheetList" class="muted">Loading…</div>
    </section>
  </main>

<script>
(() => {
  'use strict';
  const $$ = (s,r=document)=>r.querySelector(s);
  const esc = (s)=>{const d=document.createElement('div'); d.textContent=String(s??''); return d.innerHTML;};
  const BASE = new URL('.', location.href);
  const url = (p)=>new URL(p, BASE).toString();
  const qs = new URLSearchParams(location.search);
  const campaign = qs.get('campaign') || 'buctril-super-2025';
  const requestedSheet = qs.get('sheet') || '';

  $$('#backLink').href = `index.html?campaign=${encodeURIComponent(campaign)}#sessions`;

  async function fetchJson(p) {
    const r = await fetch(url(p), {cache:'no-store'});
    if (!r.ok) throw new Error(`Failed ${p} (${r.status})`);
    return await r.json();
  }

  function normalizeMediaPath(p) {
    const raw = String(p ?? '').trim();
    if (!raw) return '';
    if (/^(https?:|data:|blob:)/i.test(raw)) return raw;
    let x = raw.replace(/^\.?\//,'').replace(/^\//,'');
    if (x.startsWith('assets/')) return x;
    if (x.startsWith('gallery/')) return 'assets/' + x;
    if (!x.includes('/')) return 'assets/gallery/' + x;
    return x;
  }

  function setImg(img, p) {
    const ph = 'assets/placeholder.svg';
    img.src = url(normalizeMediaPath(p) || ph);
    img.onerror = ()=>{img.onerror=null; img.src=url(ph);};
  }

  let sheetsIndex = null;

  function renderList(filterText='') {
    const list = $$('#sheetList');
    const f = filterText.trim().toLowerCase();
    const items = (sheetsIndex?.sheets || []).filter(x => {
      if (!f) return true;
      return String(x.sheet||'').toLowerCase().includes(f)
        || String(x.village||'').toLowerCase().includes(f)
        || String(x.district||'').toLowerCase().includes(f);
    });
    list.innerHTML = `<div class="muted">Total: <b>${items.length}</b></div>` + 
      `<ul class="muted">${items.slice(0,200).map(x => {
        const href = `sheets.html?campaign=${encodeURIComponent(campaign)}&sheet=${encodeURIComponent(x.sheet)}`;
        return `<li><a class="link" href="${href}">${esc(x.sheet)}</a> — ${esc(x.district||'')} — ${esc(x.village||'')}</li>`;
      }).join('')}</ul>`;
  }

  async function loadSheet(sheetRef) {
    const meta = $$('#meta');
    const fb = $$('#feedback');
    const sigs = $$('#sigs');
    meta.textContent = 'Loading…';
    fb.textContent = 'Loading…';
    sigs.innerHTML = '';

    try {
      const sh = await fetchJson(`data/${campaign}/sheets/${sheetRef}.json`);
      const m = sh.meta || {};
      meta.innerHTML = `
        <div><b>${esc(m.sheet||sheetRef)}</b> • Date: <b>${esc(m.date||'')}</b></div>
        <div class="smallMuted">District: ${esc(m.district||'')} • Village: ${esc(m.village||'')} • Farmers present: ${esc(String(m.farmers_present||''))} • Acres: ${esc(String(m.acres||''))}</div>
      `;

      const f = sh.feedback || {};
      fb.innerHTML = `
        ${f.host_comment ? `<div><b>Host comment:</b> ${esc(f.host_comment)}</div>` : ''}
        ${f.sales_feedback ? `<div><b>Sales feedback:</b> ${esc(f.sales_feedback)}</div>` : ''}
        ${f.manager_note ? `<div><b>Manager note:</b> ${esc(f.manager_note)}</div>` : ''}
        ${(!f.host_comment && !f.sales_feedback && !f.manager_note) ? '<div class="muted">—</div>' : ''}
      `;

      const sig = sh.signatures || {};
      const host = document.createElement('img');
      host.className = 'thumb';
      host.alt = 'Host signature';
      setImg(host, sig.host);
      const sales = document.createElement('img');
      sales.className = 'thumb';
      sales.alt = 'Sales signature';
      setImg(sales, sig.sales);
      sigs.appendChild(host);
      sigs.appendChild(sales);

      // Farmers table
      const farmers = Array.isArray(sh.farmers) ? sh.farmers : [];
      const head = $$('#farmersHead');
      const body = $$('#farmersTable tbody');
      head.innerHTML = '';
      body.innerHTML = '';
      const cols = farmers.length ? Object.keys(farmers[0]) : ['sn','name','phone','village','acres','intent','used_before','other_brands_method'];
      cols.forEach(c => {
        const th = document.createElement('th');
        th.textContent = c;
        head.appendChild(th);
      });
      for (const row of farmers) {
        const tr = document.createElement('tr');
        cols.forEach(c => {
          const td = document.createElement('td');
          td.textContent = (row && row[c] != null) ? String(row[c]) : '';
          tr.appendChild(td);
        });
        body.appendChild(tr);
      }

    } catch (e) {
      meta.innerHTML = `<div class="muted">Could not load sheet.</div><div class="smallMuted">${esc(e.message)}</div>`;
      fb.textContent = '—';
    }
  }

  async function boot() {
    sheetsIndex = await fetchJson(`data/${campaign}/sheets_index.json`);
    const sel = $$('#sheetSelect');
    sel.innerHTML = (sheetsIndex.sheets || []).map(x => `<option value="${esc(x.sheet)}">${esc(x.sheet)} — ${esc(x.district||'')} — ${esc(x.village||'')}</option>`).join('');
    const initial = requestedSheet || sheetsIndex.sheets?.[0]?.sheet || '';
    sel.value = initial;
    sel.onchange = () => {
      location.href = `sheets.html?campaign=${encodeURIComponent(campaign)}&sheet=${encodeURIComponent(sel.value)}`;
    };
    $$('#sheetSearch').addEventListener('input', (ev) => renderList(ev.target.value));
    renderList('');
    await loadSheet(initial);
  }

  boot().catch(e => {
    $$('#meta').innerHTML = `<div class="muted">Failed to load.</div><div class="smallMuted">${esc(e.message)}</div>`;
    $$('#sheetList').textContent = '—';
  });
})();
</script>
</body>
</html>
