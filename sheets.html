<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Raw sheet viewer</title>
  <link rel="icon" href="favicon.ico" />
  <link rel="stylesheet" href="style.css?v=20260101" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div>
        <div class="brandTitle">Raw sheet viewer</div>
        <div class="brandSub">Audit underlying sheet exports. <a id="backLink" class="link" href="index.html">Back to report</a></div>
      </div>
    </div>
    <div class="controls">
      <div class="control">
        <label for="sheetSelect">Sheet</label>
        <select id="sheetSelect"></select>
      </div>
      <div class="control">
        <label>Search</label>
        <input id="sheetSearch" placeholder="D1S1, village, district…" />
      </div>
    </div>
  </header>

  <main class="grid2">
    <section class="card">
      <h2>Sheet details</h2>
      <!-- meta holds session details and summary -->
      <div id="meta" class="muted">Loading…</div>
      <div class="smallMuted">Use this view for audits and debugging. Business insights and actions are summarized on the main dashboard.</div>
      <div class="divider"></div>

      <div class="grid2">
        <div class="card">
          <h3>Feedback</h3>
          <div id="feedback" class="muted">—</div>
        </div>
        <div class="card">
          <h3>Signatures</h3>
          <div class="mediaRow" id="sigs"></div>
        </div>
      </div>

      <div class="divider"></div>
      <h3>Farmers</h3>
      <div class="tableWrap">
        <table class="sessionTable" id="farmersTable">
          <thead><tr id="farmersHead"></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <section class="card">
      <h2>All sheets</h2>
      <div id="sheetList" class="muted">Loading…</div>
    </section>
  </main>

<script>
(() => {
  'use strict';
  const $$ = (s,r=document)=>r.querySelector(s);
  const esc = (s)=>{const d=document.createElement('div'); d.textContent=String(s??''); return d.innerHTML;};
  const BASE = new URL('.', location.href);
  const url = (p)=>new URL(p, BASE).toString();
  const qs = new URLSearchParams(location.search);
  const campaign = qs.get('campaign') || 'buctril-super-2025';
  const requestedSheet = qs.get('sheet') || '';

  // update back link to maintain campaign context
  $$('#backLink').href = `index.html?campaign=${encodeURIComponent(campaign)}#sessions`;

  // Basic fetch helper with error handling
  async function fetchJson(p) {
    const r = await fetch(url(p), {cache:'no-store'});
    if (!r.ok) throw new Error(`Failed ${p} (${r.status})`);
    return await r.json();
  }

  function normalizeMediaPath(p) {
    const raw = String(p ?? '').trim();
    if (!raw) return '';
    if (/^(https?:|data:|blob:)/i.test(raw)) return raw;
    let x = raw.replace(/^\.?\//,'').replace(/^\//,'');
    if (x.startsWith('assets/')) return x;
    if (x.startsWith('gallery/')) return 'assets/' + x;
    if (!x.includes('/')) return 'assets/gallery/' + x;
    return x;
  }

  function setImg(img, p) {
    const ph = 'assets/placeholder.svg';
    img.src = url(normalizeMediaPath(p) || ph);
    img.onerror = ()=>{img.onerror=null; img.src=url(ph);};
  }

  let sheetsIndex = null;

  // Render the list of sheets in the side panel, highlighting the current one
  function renderList(filterText='') {
    const list = $$('#sheetList');
    const f = filterText.trim().toLowerCase();
    const items = (sheetsIndex?.sheets || []).filter(x => {
      if (!f) return true;
      return String(x.sheet||'').toLowerCase().includes(f)
        || String(x.village||'').toLowerCase().includes(f)
        || String(x.district||'').toLowerCase().includes(f);
    });
    const current = ($$('#sheetSelect')?.value || requestedSheet || '').toLowerCase();
    list.innerHTML = `<div class="muted">Total: <b>${items.length}</b></div>` + 
      `<ul class="muted">${items.slice(0,200).map(x => {
        const href = `sheets.html?campaign=${encodeURIComponent(campaign)}&sheet=${encodeURIComponent(x.sheet)}`;
        const isActive = String(x.sheet || '').toLowerCase() === current;
        return `<li><a class="link${isActive ? ' active' : ''}" href="${href}">${esc(x.sheet)}</a> — ${esc(x.district||'')} — ${esc(x.village||'')}</li>`;
      }).join('')}</ul>`;
  }

  // Helper to mask phone numbers for privacy
  function maskPhone(p) {
    const raw = String(p||'').replace(/\s+/g,'');
    if (!raw) return '';
    // keep last 4 digits if length >=4
    const tail = raw.slice(-4);
    return '***-***-' + tail;
  }

  // Load a sheet by reference, render meta, feedback, signatures and farmers
  async function loadSheet(sheetRef) {
    const meta = $$('#meta');
    const fb = $$('#feedback');
    const sigs = $$('#sigs');
    meta.textContent = 'Loading…';
    fb.textContent = 'Loading…';
    sigs.innerHTML = '';

    try {
      const sh = await fetchJson(`data/${campaign}/sheets/${sheetRef}.json`);
      const m = sh.meta || {};
      // Build meta details
      let metaHtml = `
        <div><b>${esc(m.sheet||sheetRef)}</b> • Date: <b>${esc(m.date||'')}</b></div>
        <div class="smallMuted">District: ${esc(m.district||'')} • Village: ${esc(m.village||'')} • Farmers present: ${esc(String(m.farmers_present||''))} • Acres: ${esc(String(m.acres||''))}</div>
      `;

      // Farmers table summarisation
      const farmers = Array.isArray(sh.farmers) ? sh.farmers : [];
      if (farmers.length > 0) {
        const totalFarmers = farmers.length;
        let totalAcres = 0;
        let yesCount = 0;
        let maybeCount = 0;
        let otherCount = 0;
        farmers.forEach(r => {
          const a = parseFloat(r.acres) || 0;
          totalAcres += a;
          const intent = String(r.intent||'').toLowerCase();
          if (intent.startsWith('y')) yesCount++;
          else if (intent.startsWith('m')) maybeCount++;
          else otherCount++;
        });
        metaHtml += `<div class="smallMuted">Summary: ${totalFarmers} farmers • ${totalAcres} acres • Definite: ${yesCount} • Maybe: ${maybeCount} • Others: ${otherCount}</div>`;
      }
      meta.innerHTML = metaHtml;

      // Feedback
      const f = sh.feedback || {};
      fb.innerHTML = `
        ${f.host_comment ? `<div><b>Host comment:</b> ${esc(f.host_comment)}</div>` : ''}
        ${f.sales_feedback ? `<div><b>Sales feedback:</b> ${esc(f.sales_feedback)}</div>` : ''}
        ${f.manager_note ? `<div><b>Manager note:</b> ${esc(f.manager_note)}</div>` : ''}
        ${(!f.host_comment && !f.sales_feedback && !f.manager_note) ? '<div class="muted">—</div>' : ''}
      `;

      // Signatures
      const sig = sh.signatures || {};
      const host = document.createElement('img');
      host.className = 'thumb';
      host.alt = 'Host signature';
      setImg(host, sig.host);
      const sales = document.createElement('img');
      sales.className = 'thumb';
      sales.alt = 'Sales signature';
      setImg(sales, sig.sales);
      sigs.appendChild(host);
      sigs.appendChild(sales);

      // Render farmers table
      const head = $$('#farmersHead');
      const body = $$('#farmersTable tbody');
      head.innerHTML = '';
      body.innerHTML = '';
      // Determine columns
      const rawCols = farmers.length ? Object.keys(farmers[0]) : ['sn','name','phone','village','acres','intent','used_before','other_brands_method'];
      const colMap = {
        sn: 'S#',
        name: 'Name',
        phone: 'Phone',
        village: 'Village',
        acres: 'Acres',
        intent: 'Intent',
        used_before: 'Used before',
        other_brands_method: 'Other brands method',
        district: 'District',
        date: 'Date'
      };
      rawCols.forEach(c => {
        const th = document.createElement('th');
        th.textContent = colMap[c] || c;
        head.appendChild(th);
      });
      for (const row of farmers) {
        const tr = document.createElement('tr');
        rawCols.forEach(c => {
          const td = document.createElement('td');
          let val = row && row[c] != null ? row[c] : '';
          // mask phone numbers
          if (c === 'phone') {
            val = maskPhone(val);
          }
          td.textContent = String(val);
          tr.appendChild(td);
        });
        body.appendChild(tr);
      }

    } catch (e) {
      // Show an informative message if the sheet fails to load
      meta.innerHTML = `<div class="muted">Sheet unavailable.</div><div class="smallMuted">This sheet may not have been uploaded or is missing. Please select another sheet from the list on the right.</div>`;
      fb.textContent = '—';
      sigs.innerHTML = '';
      const head = $$('#farmersHead');
      const body = $$('#farmersTable tbody');
      if (head) head.innerHTML = '';
      if (body) body.innerHTML = '';
    }
  }

  async function boot() {
    sheetsIndex = await fetchJson(`data/${campaign}/sheets_index.json`);
    const sel = $$('#sheetSelect');
    sel.innerHTML = (sheetsIndex.sheets || []).map(x => `<option value="${esc(x.sheet)}">${esc(x.sheet)} — ${esc(x.district||'')} — ${esc(x.village||'')}</option>`).join('');
    const initial = requestedSheet || sheetsIndex.sheets?.[0]?.sheet || '';
    sel.value = initial;
    sel.onchange = () => {
      location.href = `sheets.html?campaign=${encodeURIComponent(campaign)}&sheet=${encodeURIComponent(sel.value)}`;
    };
    $$('#sheetSearch').addEventListener('input', (ev) => renderList(ev.target.value));
    renderList('');
    await loadSheet(initial);
  }

  boot().catch(e => {
    $$('#meta').innerHTML = `<div class="muted">Failed to load.</div><div class="smallMuted">${esc(e.message)}</div>`;
    $$('#sheetList').textContent = '—';
  });
})();
</script>
</body>
</html>